<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>DocMind ‚Äî –†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</title>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col">
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-4xl mx-auto px-8 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">DocMind</h1>
        <p class="text-sm text-gray-500">–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
      </div>
      <a id="link-dashboard" href="dashboard.html" class="text-blue-600 hover:text-blue-800 font-medium transition duration-200 ease-in-out">‚Üê –ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>
  </header>
  <div class="flex flex-col lg:flex-row max-w-5xl mx-auto px-8 py-10 gap-8 flex-1">
  <main class="flex-1 min-w-0">
    <h2 class="text-lg font-medium text-gray-900 mb-6">–†–µ–∑—É–ª—å—Ç–∞—Ç –∞–Ω–∞–ª–∏–∑–∞</h2>
    <div id="result-content" class="bg-white rounded-xl shadow-lg border border-gray-100 p-6 text-gray-600 leading-relaxed whitespace-pre-wrap min-h-[120px]">
      <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
    </div>
    <p id="result-error" class="hidden mt-3 text-sm text-red-600"></p>
    <div class="mt-6 flex flex-wrap items-end gap-4">
      <div class="hidden flex flex-col gap-1" id="ai-magic-btn-wrap">
        <div class="flex flex-wrap items-center gap-3">
          <label for="ai-magic-audience" class="text-sm font-medium text-gray-700">–î–ª—è –∫–æ–≥–æ –æ—Ç—á—ë—Ç:</label>
          <select id="ai-magic-audience" class="px-3 py-2 border border-gray-200 rounded-lg text-gray-900 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            <option value="manager">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</option>
            <option value="business">–ë–∏–∑–Ω–µ—Å</option>
            <option value="legal">–Æ—Ä–∏—Å—Ç</option>
            <option value="student">–°—Ç—É–¥–µ–Ω—Ç</option>
          </select>
          <button id="ai-magic-btn" type="button" title="–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç" class="inline-flex items-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white font-medium rounded-lg shadow transition duration-200 ease-in-out">
            ‚ú® –£–ª—É—á—à–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          </button>
        </div>
        <span class="text-xs text-gray-500 max-w-[280px]">–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –∞–Ω–∞–ª–∏–∑ –≤ –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç</span>
      </div>
      <a id="link-dashboard-2" href="dashboard.html" class="inline-block text-blue-600 hover:text-blue-800 font-medium transition duration-200 ease-in-out pb-2">–ù–∞–∑–∞–¥ –∫ –¥–∞—à–±–æ—Ä–¥—É</a>
    </div>

    <div id="ai-magic-section" class="hidden mt-10">
      <h3 class="text-lg font-medium text-gray-900 mb-4">–ü–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç (AI Magic)</h3>
      <div id="ai-magic-loading" class="hidden bg-white rounded-xl shadow-lg border border-gray-100 p-8 text-center text-gray-500">
        –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–Ω—è—Ç–Ω—ã–π –æ—Ç—á—ë—Ç‚Ä¶
      </div>
      <div id="ai-magic-report" class="space-y-4">
        <!-- –°–µ–∫—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞ –ø–æ–¥–≥—Ä—É–∂–∞—é—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
      </div>
      <div id="export-report-wrap" class="hidden mt-4">
        <button id="export-report-btn" type="button" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium rounded-lg border border-gray-200 transition duration-200 ease-in-out">
          üìÑ –°–∫–∞—á–∞—Ç—å –æ—Ç—á—ë—Ç (PDF)
        </button>
      </div>
      <div id="explain-ai-wrap" class="hidden mt-6">
        <button id="explain-ai-btn" type="button" class="text-sm text-gray-600 hover:text-blue-600 font-medium">–ü–æ—á–µ–º—É –ò–ò —Ç–∞–∫ —Å–∫–∞–∑–∞–ª?</button>
        <div id="explain-ai-block" class="hidden mt-3 p-4 bg-gray-50 rounded-lg border border-gray-100 text-sm text-gray-600">
          <p class="mb-2">–û—Ç—á—ë—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ:</p>
          <ul id="explain-ai-sources" class="list-disc list-inside space-y-1"></ul>
          <p class="mt-2">–ú–æ–¥–µ–ª—å –æ–±—ä–µ–¥–∏–Ω–∏–ª–∞ —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –≤ –µ–¥–∏–Ω—ã–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ—Ç—á—ë—Ç.</p>
        </div>
      </div>
      <p id="ai-magic-error" class="hidden mt-3 text-sm text-red-600"></p>
    </div>
  </main>
  <aside id="document-history-sidebar" class="w-full lg:w-64 shrink-0">
    <h3 class="text-sm font-semibold text-gray-700 mb-3">–†–∞–Ω–µ–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ</h3>
    <ul id="document-history-list" class="space-y-2 text-sm">
      <li class="text-gray-400">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</li>
    </ul>
    <a id="document-history-dashboard-link" href="dashboard.html" class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm font-medium">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã ‚Üí</a>
  </aside>
  </div>
  <footer class="mt-auto border-t border-gray-200 bg-white py-4 text-center text-sm text-gray-500">
    –ù–∞ –±–∞–∑–µ –ò–ò ‚Ä¢ –°–¥–µ–ª–∞–Ω–æ –≤ Cursor ‚Ä¢ –ü—Ä–æ–µ–∫—Ç —Ö–∞–∫–∞—Ç–æ–Ω–∞
  </footer>
  <script>
    (function () {
      function extractDetail(d) {
        if (!d || d.detail == null) return '';
        if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || (typeof x === 'string' ? x : ''); }).filter(Boolean).join('. ') || '';
        return typeof d.detail === 'string' ? d.detail : '';
      }
      function userFriendlyMessage(err) {
        var msg = (err && err.message) ? String(err.message) : '';
        if (msg === 'Failed to fetch' || msg.indexOf('NetworkError') !== -1) return '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.';
        return msg || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç.';
      }
      var params = new URLSearchParams(window.location.search);
      var resultId = params.get('result_id');
      var userId = params.get('user_id') || sessionStorage.getItem('user_id');

      var linkDashboard = document.getElementById('link-dashboard');
      var linkDashboard2 = document.getElementById('link-dashboard-2');
      var dashboardHref = userId ? ('dashboard.html?user_id=' + encodeURIComponent(userId)) : 'dashboard.html';
      linkDashboard.href = dashboardHref;
      linkDashboard2.href = dashboardHref;

      var contentEl = document.getElementById('result-content');
      var errorEl = document.getElementById('result-error');
      var documentId = null;
      var lastReportText = '';

      if (!resultId) {
        contentEl.textContent = '';
        errorEl.textContent = '–ù–µ —É–∫–∞–∑–∞–Ω —Ä–µ–∑—É–ª—å—Ç–∞—Ç (result_id).';
        errorEl.classList.remove('hidden');
        return;
      }

      fetch('/api/results/' + encodeURIComponent(resultId))
        .then(function (r) {
          if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
          return r.json();
        })
        .then(function (data) {
          documentId = data.document_id;
          contentEl.textContent = data.content || '';
          errorEl.classList.add('hidden');
          if (documentId != null) {
            document.getElementById('ai-magic-btn-wrap').classList.remove('hidden');
          }
        })
        .catch(function (err) {
          contentEl.textContent = '';
          contentEl.classList.add('hidden');
          errorEl.textContent = userFriendlyMessage(err);
          errorEl.classList.remove('hidden');
        });

      document.getElementById('ai-magic-btn').addEventListener('click', function () {
        if (documentId == null) return;
        var section = document.getElementById('ai-magic-section');
        var loading = document.getElementById('ai-magic-loading');
        var reportEl = document.getElementById('ai-magic-report');
        var magicError = document.getElementById('ai-magic-error');
        var btn = document.getElementById('ai-magic-btn');

        section.classList.remove('hidden');
        reportEl.innerHTML = '';
        magicError.classList.add('hidden');
        loading.classList.remove('hidden');
        btn.disabled = true;

        fetch('/api/ai-magic', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ document_id: documentId, audience: (document.getElementById('ai-magic-audience') && document.getElementById('ai-magic-audience').value) || null })
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
            return r.json();
          })
          .then(function (data) {
            loading.classList.add('hidden');
            btn.disabled = false;
            var report = (data.report || '').trim();
            lastReportText = report;
            if (!report) {
              reportEl.innerHTML = '<p class="text-gray-500">–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç.</p>';
              return;
            }
            var parts = report.split(/\n\n(?=\d+\.\s+)/);
            parts.forEach(function (part) {
              part = part.trim();
              if (!part) return;
              var firstLineEnd = part.indexOf('\n');
              var title = firstLineEnd > 0 ? part.substring(0, firstLineEnd).trim() : part;
              var body = firstLineEnd > 0 ? part.substring(firstLineEnd + 1).trim() : '';
              var titleLower = title.toLowerCase();
              var cardClass = 'rounded-xl shadow-sm border border-gray-100 p-5 ';
              if (/risks?|red\s*flags?/.test(titleLower)) {
                cardClass += 'bg-red-50/50 border-l-4 border-l-red-500';
              } else if (/opportunit(y|ies)/.test(titleLower)) {
                cardClass += 'bg-green-50/50 border-l-4 border-l-green-600';
              } else if (/recommendations?/.test(titleLower)) {
                cardClass += 'bg-blue-50/50 border-l-4 border-l-blue-500';
              } else {
                cardClass += 'bg-white';
              }
              var card = document.createElement('div');
              card.className = cardClass;
              card.innerHTML = '<h4 class="text-gray-900 font-medium mb-2">' + escapeHtml(title) + '</h4><div class="text-gray-600 text-sm leading-relaxed whitespace-pre-wrap">' + emphasizePhrases(escapeHtml(body)) + '</div>';
              reportEl.appendChild(card);
            });
            if (reportEl.children.length === 0) {
              reportEl.innerHTML = '<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5 text-gray-600 leading-relaxed whitespace-pre-wrap">' + escapeHtml(report) + '</div>';
            }
            var downloadWrap = document.getElementById('export-report-wrap');
            if (downloadWrap) downloadWrap.classList.remove('hidden');
            var explainWrap = document.getElementById('explain-ai-wrap');
            if (explainWrap) {
              explainWrap.classList.remove('hidden');
              loadExplainAiSources(documentId);
            }
          })
          .catch(function (err) {
            loading.classList.add('hidden');
            btn.disabled = false;
            magicError.textContent = userFriendlyMessage(err);
            magicError.classList.remove('hidden');
          });
      });

      document.getElementById('export-report-btn').addEventListener('click', function () {
        if (!lastReportText) return;
        var btn = document.getElementById('export-report-btn');
        btn.disabled = true;
        fetch('/api/export-report', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ report_text: lastReportText })
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
            return r.blob();
          })
          .then(function (blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'DocMind_–û—Ç—á—ë—Ç.pdf';
            a.click();
            URL.revokeObjectURL(url);
          })
          .catch(function (err) {
            var magicError = document.getElementById('ai-magic-error');
            magicError.textContent = userFriendlyMessage(err);
            magicError.classList.remove('hidden');
          })
          .finally(function () { btn.disabled = false; });
      });

      (function loadDocumentHistory() {
        var listEl = document.getElementById('document-history-list');
        var dashLink = document.getElementById('document-history-dashboard-link');
        if (!userId || !listEl) return;
        dashLink.href = dashboardHref;
        fetch('/api/users/' + encodeURIComponent(userId) + '/documents')
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d)); }, function () { throw new Error(); });
            return r.json();
          })
          .then(function (docs) {
            listEl.innerHTML = '';
            if (!docs || docs.length === 0) {
              listEl.innerHTML = '<li class="text-gray-400">–ù–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</li>';
              return;
            }
            docs.slice(0, 10).forEach(function (d) {
              var li = document.createElement('li');
              var a = document.createElement('a');
              a.href = 'analyze.html?document_id=' + encodeURIComponent(d.id) + '&user_id=' + encodeURIComponent(userId);
              a.className = 'text-blue-600 hover:text-blue-800 truncate block';
              a.textContent = d.filename || '–î–æ–∫—É–º–µ–Ω—Ç ‚Ññ' + d.id;
              li.appendChild(a);
              listEl.appendChild(li);
            });
          })
          .catch(function () {
            listEl.innerHTML = '<li class="text-gray-400">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫</li>';
          });
      })();

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function emphasizePhrases(htmlSafeText) {
        return htmlSafeText.replace(/\*\*([^*]+)\*\*/g, '<strong class="font-semibold text-gray-800">$1</strong>');
      }

      document.getElementById('explain-ai-btn').addEventListener('click', function () {
        var block = document.getElementById('explain-ai-block');
        block.classList.toggle('hidden');
      });

      function loadExplainAiSources(docId) {
        var listEl = document.getElementById('explain-ai-sources');
        if (!docId || !listEl) return;
        fetch('/api/documents/' + encodeURIComponent(docId) + '/results')
          .then(function (r) {
            if (!r.ok) return [];
            return r.json();
          })
          .then(function (results) {
            listEl.innerHTML = '';
            var types = { summary: '–ö—Ä–∞—Ç–∫–æ–µ –∏–∑–ª–æ–∂–µ–Ω–∏–µ', action_items: '–î–µ–π—Å—Ç–≤–∏—è', risks: '–†–∏—Å–∫–∏', explain_simple: '–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º–∏ —Å–ª–æ–≤–∞–º–∏' };
            var li = document.createElement('li');
            li.textContent = '–¢–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞';
            listEl.appendChild(li);
            (results || []).forEach(function (r) {
              var item = document.createElement('li');
              item.textContent = '–ê–Ω–∞–ª–∏–∑: ' + (types[r.analysis_type] || r.analysis_type);
              listEl.appendChild(item);
            });
          })
          .catch(function () { listEl.innerHTML = '<li>–î–æ–∫—É–º–µ–Ω—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–µ –∞–Ω–∞–ª–∏–∑—ã</li>'; });
      }
    })();
  </script>
</body>
</html>
