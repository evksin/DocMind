<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>DocMind ‚Äî –î–∞—à–±–æ—Ä–¥</title>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col">
  <header class="bg-white border-b border-gray-200 shadow-sm">
    <div class="max-w-4xl mx-auto px-8 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-semibold text-gray-900">DocMind</h1>
        <p class="text-sm text-gray-500">–£–º–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>
      </div>
      <p class="text-sm text-gray-400"><span id="username">‚Äî</span></p>
    </div>
  </header>
  <main class="max-w-4xl mx-auto px-8 py-10 flex-1">
    <div class="flex justify-between items-center mb-6 flex-wrap gap-3">
      <h2 class="text-lg font-medium text-gray-900">–ú–æ–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h2>
      <div class="flex flex-wrap items-center gap-3">
        <div class="flex flex-col gap-1">
          <div class="flex items-center gap-2">
            <button type="button" id="demo-btn" class="inline-flex items-center justify-center w-[280px] px-4 py-2.5 border border-gray-200 rounded-lg text-gray-700 hover:bg-gray-50 font-medium transition duration-200 ease-in-out">
              üìÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ
            </button>
            <a id="demo-view-doc" href="/api/demo/document" target="_blank" rel="noopener noreferrer" class="text-sm text-blue-600 hover:text-blue-800 font-medium whitespace-nowrap">
              –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
            </a>
          </div>
          <p class="text-xs text-gray-500">–î–æ–∫—É–º–µ–Ω—Ç: <span id="demo-doc-name">demo_report.pdf</span></p>
        </div>
        <a id="link-upload" href="upload.html" class="inline-flex items-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white font-medium rounded-lg shadow transition duration-200 ease-in-out">
          –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
        </a>
      </div>
    </div>
    <ul id="documents-list" class="space-y-4">
      <!-- –°–ø–∏—Å–æ–∫ –ø–æ–¥–≥—Ä—É–∂–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
    </ul>
  </main>
  <footer class="mt-auto border-t border-gray-200 bg-white py-4 text-center text-sm text-gray-500">–ù–∞ –±–∞–∑–µ –ò–ò ‚Ä¢ –°–¥–µ–ª–∞–Ω–æ –≤ Cursor ‚Ä¢ –ü—Ä–æ–µ–∫—Ç —Ö–∞–∫–∞—Ç–æ–Ω–∞</footer>
  <script>
    (function () {
      var params = new URLSearchParams(window.location.search);
      var userId = params.get('user_id') || sessionStorage.getItem('user_id');
      if (!userId) {
        window.location.href = 'index.html';
        return;
      }
      var usernameEl = document.getElementById('username');
      usernameEl.textContent = sessionStorage.getItem('username') || '‚Äî';
      var linkUpload = document.getElementById('link-upload');
      linkUpload.href = 'upload.html?user_id=' + encodeURIComponent(userId);
      var listEl = document.getElementById('documents-list');
      function extractDetail(d) {
        if (!d || d.detail == null) return '';
        if (Array.isArray(d.detail)) return d.detail.map(function (x) { return x.msg || x.message || (typeof x === 'string' ? x : ''); }).filter(Boolean).join('. ') || '';
        return typeof d.detail === 'string' ? d.detail : '';
      }
      function userFriendlyMessage(err) {
        var msg = (err && err.message) ? String(err.message) : '';
        if (msg === 'Failed to fetch' || msg.indexOf('NetworkError') !== -1) return '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω.';
        return msg || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.';
      }
      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function renderDocs(docs) {
        if (docs.length === 0) {
          var uploadUrl = 'upload.html?user_id=' + encodeURIComponent(userId);
          listEl.innerHTML = '<li class="bg-white rounded-xl shadow-sm border border-gray-100 px-6 py-14 text-center">' +
            '<svg class="w-16 h-16 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>' +
            '<p class="text-gray-900 font-medium mb-1">–ù–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</p>' +
            '<p class="text-gray-600 text-sm mb-5">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ø–µ—Ä–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∞–Ω–∞–ª–∏–∑</p>' +
            '<a href="' + uploadUrl + '" class="inline-flex items-center px-5 py-2.5 bg-blue-600 hover:bg-blue-700 active:scale-[0.98] text-white font-medium rounded-lg shadow transition duration-200 ease-in-out">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç</a>' +
            '</li>';
          return;
        }
        listEl.innerHTML = docs.map(function (d) {
          var date = d.uploaded_at ? new Date(d.uploaded_at).toLocaleString('ru-RU') : '';
          var analyzeUrl = 'analyze.html?user_id=' + encodeURIComponent(userId) + '&document_id=' + encodeURIComponent(d.id);
          return '<li class="bg-white rounded-xl shadow-sm hover:shadow-md hover:-translate-y-0.5 transition duration-200 ease-in-out border border-gray-100 px-6 py-4 flex flex-wrap items-center justify-between gap-3" data-document-id="' + escapeHtml(String(d.id)) + '">' +
            '<div class="min-w-0">' +
            '<p class="font-semibold text-gray-900 truncate">' + escapeHtml(d.filename) + '</p>' +
            '<p class="text-sm text-gray-400 mt-0.5">' + escapeHtml(date) + '</p>' +
            '</div>' +
            '<div class="flex items-center gap-3 shrink-0">' +
            '<a href="' + analyzeUrl + '" class="text-blue-600 hover:text-blue-800 font-medium">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</a>' +
            '<button type="button" class="btn-delete text-red-500 hover:text-red-700 font-medium" data-document-id="' + escapeHtml(String(d.id)) + '">–£–¥–∞–ª–∏—Ç—å</button>' +
            '</div></li>';
        }).join('');
        listEl.querySelectorAll('.btn-delete').forEach(function (btn) {
          btn.addEventListener('click', function () {
            var docId = btn.getAttribute('data-document-id');
            if (!docId || !confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç? –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —Ç–æ–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) return;
            fetch('/api/users/' + encodeURIComponent(userId) + '/documents/' + encodeURIComponent(docId) + '/delete', { method: 'POST' })
              .then(function (r) {
                if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
                return loadDocs();
              })
              .catch(function (err) {
                alert(userFriendlyMessage(err));
              });
          });
        });
      }
      function loadDocs() {
        return fetch('/api/users/' + encodeURIComponent(userId) + '/documents')
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
            return r.json();
          })
          .then(renderDocs);
      }
      loadDocs().catch(function (err) {
        listEl.innerHTML = '<li class="bg-white rounded-xl shadow-sm border border-gray-100 px-6 py-12 text-center text-sm text-red-600">' + escapeHtml(userFriendlyMessage(err)) + '</li>';
      });

      document.getElementById('demo-btn').addEventListener('click', function () {
        var btn = document.getElementById('demo-btn');
        btn.disabled = true;
        btn.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
        fetch('/api/demo/run', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id: parseInt(userId, 10) })
        })
          .then(function (r) {
            if (!r.ok) return r.json().then(function (d) { throw new Error(extractDetail(d) || r.statusText); }, function () { throw new Error(r.statusText); });
            return r.json();
          })
          .then(function (data) {
            window.location.href = 'result.html?result_id=' + encodeURIComponent(data.result_id) + '&user_id=' + encodeURIComponent(userId);
          })
          .catch(function (err) {
            alert(userFriendlyMessage(err));
            btn.disabled = false;
            btn.textContent = 'üìÑ –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–∞ –ø—Ä–∏–º–µ—Ä–µ';
          });
      });
    })();
  </script>
</body>
</html>
